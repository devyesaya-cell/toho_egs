# Diagram Generation Rules

This document outlines the standard process for generating Detailed C4 Level 4 Component Diagrams and Detailed Class Diagrams for this project.

## Workflow Trigger

### 1. Detailed Diagram (Exhaustive Block Diagram)
- **Prompt**: `"Make Diagram Detail for @[file.dart]"`
- **Output**: `docs/dia_detail_[name].drawio`
- **Style**: **Exhaustive Block Diagram**.
    -   **Focus**: Internal Methods.
    -   **Structure**: Main Container = Class. Blocks = All Methods.
    -   **Content**: Inputs, Outputs, Models, Description per method.

### 2. C4 Level 4 (Component Interaction Diagram)
- **Prompt**: `"Make C4 Lv4 for @[file.dart]"`
- **Output**: `docs/c4_lv4_[name].drawio`
- **Style**: **Component Interaction Diagram** (Based on Dashboard Presenter & Page examples).
    -   **Focus**: Relationships between the Main Component, its State/Data, and External Services.
    -   **Structure**:
        -   **Main Component**: The Class itself (e.g., `DashboardPresenter`, `LoginPage`).
        -   **State/Data Objects**: Separate blocks for state classes (e.g., `DashboardData`, `DashboardFilter`).
        -   **External Dependencies**: Database, Services, Repositories, Providers.
        -   **Models**: Data models being manipulated.
    -   **Relationships**: Arrows showing flow (e.g., "Manages", "Exposes", "Queries", "Updates").
    -   **Content**: Brief description of responsibility for each block.

## Output Location
All generated diagrams must be saved in the `docs/` folder.

## Naming Convention Summary
| Diagram Type | Naming Pattern | Scope |
| :--- | :--- | :--- |
| **Detailed Diagram** | `dia_detail_[name].drawio` | **Internal Logic** (Method Breakdown) |
| **C4 Level 4** | `c4_lv4_[name].drawio` | **Component Relationships** (Data Flow) |

## Diagram Standards

### A. Detailed Diagram Standards
- **Format**: Draw.io XML.
- **Structure**:
    1.  **Main Container**: Represents the Component.
    2.  **Internal Blocks**: One block per significant method.
    3.  **Content**: Header (Method Name), Body (In, Out, Models, Desc).
- **Color Coding**:
    -   Grey/White (#f5f5f5): Standard Methods.
    -   Blue (#dae8fc): State/Logic Helpers.
    -   Green (#d5e8d4): Init/Data Loading.
    -   Purple (#e1d5e7): Complex Logic.
    -   Orange (#ffe6cc): User Interaction.

### B. C4 Level 4 Standards
- **Format**: Draw.io XML.
- **Color Coding**:
    -   **Yellow** (#fff2cc): Main Component / Logic Unit.
    -   **Red/Pink** (#f8cecc): Filter / Config State.
    -   **Green** (#d5e8d4): Data State / Results.
    -   **Purple** (#e1d5e7): Database / External Service.
    -   **Grey** (#f5f5f5): Data Models.

# System Context & Environment

## Flutter Doctor Output
```
[√] Flutter (Channel stable, 3.38.1, on Microsoft Windows [Version 10.0.26100.7623], locale en-ID)
    • Flutter version 3.38.1 on channel stable at C:\flutter\flutter
    • Upstream repository https://github.com/flutter/flutter.git
    • Framework revision b45fa18946 (3 months ago), 2025-11-12 22:09:06 -0600
    • Engine revision b5990e5ccc
    • Dart version 3.10.0
    • DevTools version 2.51.1
```

## Key Dependencies (pubspec.yaml)
- **Environment**: sdk: ^3.10.0
- **State Management**: flutter_riverpod: ^3.2.1
- **Database**: isar_community: 3.3.0-dev.3, isar_community_flutter_libs: 3.3.0-dev.3
- **Utilities**:
  - path_provider: ^2.1.5
  - path: ^1.8.3
  - intl: ^0.20.2
  - permission_handler: ^11.3.0
  - device_info_plus: ^10.1.0
- **UI/Visualization**:
  - maplibre: ^0.3.3
  - fl_chart: ^1.1.1
  - percent_indicator: ^4.2.5
- **Hardware/Connectivity**:
  - usb_serial: ^0.5.2
- **Testing**:
  - flutter_test: sdk: flutter
  - flutter_lints: ^3.0.0

# General Rules

## Context Check
- **ALWAYS** check the `context7` MCP server first for every prompt to ensure access to the latest database updates and context.

## UI Design Rules (Dark Theme)
The application follows a dark green theme. When implementing UI components, use these standard colors:
- **Main Background**: `Color(0xFF0F1410)` (Deep dark green/black for main pages and panels)
- **Surface Dark**: `Color(0xFF1E293B)` (For cards, inner containers, and dialogs)
- **Border / Light Green Hint**: `Color(0xFF1E3A2A)` (For borders, dividers, and selected menu backgrounds)
- **Primary Green / Active**: `Color(0xFF2ECC71)` (For active text, icons, and primary indicators)
- **Text Grey / Inactive**: `Color(0xFFB0BEC5)` (For secondary text, unselected menu items)
- **Red / Error**: `Color(0xFFEF4444)` (For error status text and icons)
- **Dark Red Hint**: `Color(0xFF3F1D1D)` (For error status background containers)

## Architecture & Layout Rules
1. **Presenter Pattern (MVVM)**: Every major feature or page must have its logic separated into a `Presenter` class (implementing Riverpod's `Notifier` or `StateNotifier`).
2. **Clean UI**: UI components (`Widget` classes) must remain as thin as possible. Avoid writing complex logic, boolean toggles, timers, or DB transactions directly in `StatefulWidget` states. Use `ConsumerWidget` and delegate all actions to the Presenter. 
3. **Stream Management**: Never use the classic Flutter `StreamBuilder` for fetching asynchronous list operations from Isar or APIs. Always wrap streams in a Riverpod `StreamProvider` and use the `.when(data: , loading: , error: )` syntax in the UI. This provides better caching and prevents UI flickering.
4. **Scaffold & AppBar**: When creating a new page's Scaffold, the standard `AppBar` should consist of:
   - A `title` on the left.
   - The reusable `StatusBar` (containing the USB connection indicator and user `ProfileWidget`) placed in the `actions` array on the right.

**Example implementation reference**: `lib/features/timesheet/timesheet_page.dart` and `lib/features/timesheet/presenter/timesheet_presenter.dart`.
